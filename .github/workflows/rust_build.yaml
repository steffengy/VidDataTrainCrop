name: Rust Build

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            artifact_name: vid-data-tool-windows.exe
            asset_name: vid-data-tool-windows
          - os: ubuntu-latest
            artifact_name: vid-data-tool-linux
            asset_name: vid-data-tool-linux

    steps:
    - uses: actions/checkout@v4

    # 1. Install System Dependencies (OpenCV)
    - name: Install OpenCV (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y libopencv-dev clang libclang-dev

    - name: Install OpenCV (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        choco install -y opencv

    - name: Install and Set OpenCV Env Vars
      if: matrix.os == 'windows-latest'
      run: |
        # 1. Install OpenCV
        choco install opencv -y

        # 2. Locate the installation root
        $opencvRoot = Get-ChildItem -Path "C:\tools" -Recurse -Directory -Filter "opencv" |
                        Select-Object -ExpandProperty FullName -First 1
        $buildDir = Join-Path $opencvRoot "build"

        # 3. Set Include Path
        $includePath = Join-Path $buildDir "include"
        echo "OPENCV_INCLUDE_PATHS=$includePath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

        # 4. Find the Link Path (x64\vc*\lib)
        $libDir = Get-ChildItem -Path "$buildDir\x64" -Directory |
                  Where-Object { $_.Name -like "vc*" } |
                  Select-Object -ExpandProperty FullName -First 1 |
                  ForEach-Object { Join-Path $_ "lib" }

        echo "OPENCV_LINK_PATHS=$libDir" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

        # 5. Find the exact world library name (e.g., opencv_world4110)
        # We look for opencv_world4*.lib but exclude 'd' (debug) versions
        $libFile = Get-ChildItem -Path $libDir -Filter "opencv_world4*.lib" |
                    Where-Object { $_.BaseName -notlike "*d" } |
                    Select-Object -ExpandProperty BaseName -First 1

        echo "OPENCV_LINK_LIBS=$libFile" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

        # 6. Add DLLs to PATH for runtime (x64\vc*\bin)
        $binDir = $libDir.Replace("\lib", "\bin")
        echo "$binDir" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

        # Debug: Print found values
        Write-Host "Detected Include: $includePath"
        Write-Host "Detected Lib Dir: $libDir"
        Write-Host "Detected Lib Name: $libFile"

    # 2. Setup Rust
    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable

    # 3. Build
    - name: Build Release
      run: cargo build --release

    # 4. Upload Artifacts
    - name: Upload Binary
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.asset_name }}
        path: |
          target/release/viddatatraincrop.exe
          target/release/viddatatraincrop
